<!doctype html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IAT Words — 9 Parts</title>
<style>
  body { font-family:"Times New Roman",serif; background:#f7fbfd; margin:0; }
  .frame { border:6px solid #bfe3f1; background:#fff; padding:24px 30px; width:900px; max-width:94vw; margin:36px auto; }
  .top { display:grid; grid-template-columns:1fr auto 1fr; }
  .hint { font-size:13px; color:#333; text-align:center; }
  .left,.right { font-size:32px; font-weight:700; color:#2f9b30; margin-top:6px; }
  .left { text-align:left } .right { text-align:right }
  .part { text-align:center; margin:18px 0; font-weight:700; }
  .instructions { font-size:16px; line-height:1.55; color:#111; }
  .instructions .category{ color:#2f9b30; font-weight:700 }
  .instructions .redx{ color:#c62828; font-weight:800 }
  .start { text-align:center; margin-top:22px; font-size:18px; font-weight:700 }
  .btn{ display:inline-block; padding:10px 16px; border:1px solid #b3b3b3; border-radius:4px; background:#f6f6f6; cursor:pointer; font-weight:700 }
  .btn:active{ transform:translateY(1px) }
  .hidden { display:none }
  .stimulus { text-align:center; font-size:46px; font-weight:700; margin:56px 0 12px }
  .bigx{ color:#c62828; font-weight:800; font-size:42px; text-align:center; margin-top:6px; }
  .form-row{ display:grid; grid-template-columns:180px 1fr; align-items:center; gap:10px; margin:10px 0; }
  label{ font-weight:700 }
  input, select{ font-family:inherit; font-size:16px; padding:8px 10px; border:1px solid #b3b3b3; border-radius:4px }
  .note{ font-size:14px; color:#444 }
  .err{ color:#c62828; font-size:14px; margin-top:8px }

  /* Mobile buttons for E/I */
  .mobile-buttons { display: none; justify-content: center; gap: 20px; margin: 30px 0; }
  .mobile-btn { padding: 15px 30px; font-size: 20px; font-weight: 700; border: 2px solid #2f9b30; border-radius: 8px; background: #f0f9f0; cursor: pointer; min-width: 100px; text-align: center; }
  .mobile-btn:active { background: #d0f0d0; transform: translateY(2px); }
  .mobile-btn-e { border-color: #2f5b9b; background: #f0f0f9; }
  .mobile-btn-i { border-color: #9b2f5b; background: #f9f0f3; }

  /* Survey Styles */
  .survey-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 16px; color: #2f9b30; }
  .survey-intro { font-size: 14px; line-height: 1.5; color: #444; margin-bottom: 20px; text-align: center; padding: 0 10px; }
  .survey-nav { text-align: center; margin-top: 24px; }
  .survey-question { margin: 16px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f9f9f9; }
  .survey-question-text { font-weight: 600; margin-bottom: 12px; font-size: 15px; }
  .survey-options { display: flex; flex-direction: column; gap: 10px; }
  .survey-option { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 4px; cursor: pointer; }
  .survey-option:hover { background: #e8f4fd; }
  .survey-option input { margin: 0; }
  .survey-option label { font-weight: normal; cursor: pointer; margin: 0; }

  /* Completion UI */
  .results-box { border:6px solid #bfe3f1; background:#fff; padding:20px 24px; width:900px; max-width:94vw; margin:24px auto; }
  .results-title { font-size:18px; font-weight:700; margin-bottom:8px; }
  .results-role { margin:8px 0; padding:10px; border-radius:8px; background:#f3f7fb; }
  .results-actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
  .btn-primary { background:#2b6df6; color:#fff; border-color:#2b6df6; }
  .btn-success { background:#2fb56e; color:#fff; border-color:#2fb56e; }
  .btn-warning { background:#f0ad4e; color:#fff; border-color:#f0ad4e; }
  .small-note { margin-top:10px; color:#6b7280; font-size:13px; }
  pre.results-preview { white-space:pre-wrap; background:#0b1220; color:#eaf0ff; padding:10px; border-radius:6px; margin-top:12px; overflow:auto; max-height:240px; }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .frame { padding: 16px 20px; margin: 20px auto; }
    .mobile-buttons { display: flex; }
    .stimulus { font-size: 36px; margin: 30px 0 12px; }
    .left, .right { font-size: 24px; }
    .form-row { grid-template-columns: 1fr; gap: 5px; }
  }
</style>
</head>
<body>

<!-- ===== 1) SETUP ===== -->
<div class="frame" id="setup">
  <div class="part">Оролцогчийн мэдээлэл</div>
  <div class="form-row">
    <label for="pid">ID / Нэр<span style="color:#c62828">*</span></label>
    <input id="pid" placeholder="Жишээ: B.Batbayar" />
  </div>
  <div class="form-row">
    <label for="age">Нас<span style="color:#c62828">*</span></label>
    <input id="age" type="number" min="5" max="120" placeholder="Жишээ: 23" />
  </div>
  <div class="form-row">
    <label for="gender">Хүйс</label>
    <select id="gender">
      <option value="">Сонгох</option>
      <option value="male">Эр</option>
      <option value="female">Эм</option>
      <option value="other">Бусад</option>
    </select>
  </div>
  <div class="note">Enter дарж эсвэл доорх товчийг дарж үргэлжлүүлнэ.</div>
  <div style="text-align:center; margin-top:14px">
    <button class="btn" type="button" onclick="window.goIntro()">Зааварт шилжих</button>
  </div>
  <div class="err hidden" id="setupErr"></div>
</div>

<!-- ===== 2) INSTRUCTIONS ===== -->
<div class="frame hidden" id="intro">
  <div class="top">
    <div class="hint">Press "E" for</div><div></div><div class="hint">Press "I" for</div>
    <div class="left" id="leftCategory">Би</div><div></div><div class="right" id="rightCategory">Тэд</div>
  </div>
  <div class="part" id="introPartLabel">Part 1 of 9</div>
  <div class="instructions" id="instructionsText">
    <p>Зүүн гарын дунд эсвэл долоовор хурууг компьютерийн гарны E товчлуур, баруун гарын дунд эсвэл долоовор хурууг компьютерийн гарны I товчлуур дээр тус тус байрлуул. ... Та зааврыг ойлгосон бол "ЗАЙ АВАХ ТОВЧЛУУР" дарж туршилтыг эхэлнэ.</p>
  </div>
  <div class="start">Press the <b>space bar</b> when you are ready to start.</div>
  <div style="text-align:center; margin-top:12px">
    <button class="btn" id="btnStart">Эхлэх</button>
  </div>
</div>

<!-- ===== 3) STAGE ===== -->
<div class="frame hidden" id="stage">
  <div class="top">
    <div class="hint">Press "E" for</div><div></div><div class="hint">Press "I" for</div>
    <div class="left" id="stageLeftCategory">Би</div><div></div><div class="right" id="stageRightCategory">Тэд</div>
  </div>
  <div class="part" id="partLabel">Part 1 of 9</div>
  <div class="stimulus" id="stimulusWord">Smile</div>
  
  <!-- Mobile buttons for E/I -->
  <div class="mobile-buttons" id="mobileButtons">
    <button class="mobile-btn mobile-btn-e" id="btnMobileE">E</button>
    <button class="mobile-btn mobile-btn-i" id="btnMobileI">I</button>
  </div>
  
  <div id="errorX" class="bigx hidden">X</div>
</div>

<!-- ===== 4) SURVEY 1: Self-Esteem ===== -->
<div class="frame hidden" id="survey1">
  <div class="survey-title">Өөрийн Үнэлэмжийн Асуулга</div>
  <div class="survey-intro">
    Энэ асуулга нь таны өөрийгөө үнэлэх түвшинг тодорхойлох зорилготой. Та өгүүлбэр бүрийг уншаад өөрт хамгийн ойр санагдсан хариултыг сонгоно уу. Зөв буруу гэсэн хариулт байхгүй учир таны мэдрэмж, бодол хамгийн зөв хариулт болно. Хариулахдаа доорх дөрвөн сонголтоос аль нэгийг тэмдэглэнэ үү.
  </div>
  <div id="survey1Questions"></div>
  <div class="survey-nav">
    <button class="btn btn-success" id="btnSurvey1Next">Дараачийн асуулга руу шилжих</button>
  </div>
  <div class="err hidden" id="survey1Err"></div>
</div>

<!-- ===== 5) SURVEY 2: Emotions ===== -->
<div class="frame hidden" id="survey2">
  <div class="survey-title">Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга</div>
  <div class="survey-intro">
    Энэхүү асуулга нь тодорхой агшинд төрж буй сэтгэл хөдлөл, мэдрэмжийг тэмдэглэх зорилготой үгсийн жагсаалтаас бүрдсэн болно. Эдгээрээс танд үүсч буй сэтгэл мэдрэмжид тохирсон үзүүлэлтийг сонгоно уу.
  </div>
  <div id="survey2Questions"></div>
  <div class="survey-nav">
    <button class="btn btn-success" id="btnSurvey2Submit">Дуусгах</button>
  </div>
  <div class="err hidden" id="survey2Err"></div>
</div>

<!-- ===== 6) COMPLETION (mount) ===== -->
<div id="completionMount"></div>

<script>
/* ========== Constants & Data ========== */
const TOTAL_PARTS = 9;

const SELF_WORDS = ["Би", "надад", "миний", "минийх", "өөрөө"];
const OTHER_WORDS = ["тэднийг", "тэдний", "тэднийх", "тэдэнд", "тэд"];
const POS_WORDS = ["гайхамшигтай", "үзэсгэлэнтэй", "сайхан", "сайн", "жаргалтай"];
const NEG_WORDS = ["Шоовдор", "зовлонтой", "харгис", "аймаар", "ядаргаатай"];

// Instructions for each part
const PART_INSTRUCTIONS = [
  // Part 1: Self vs Others
  "Зүүн гарын дунд эсвэл долоовор хурууг компьютерийн гарны E товчлуур, баруун гарын дунд эсвэл долоовор хурууг компьютерийн гарны I товчлуур дээр тус тус байрлуул. Дэлгэцийн зүүн дээд талд \"Би\", баруун дээд талд \"Тэд\" гэсэн 2 ангилал өгөгдөнө. Дэлгэцийн дээд талд өгөгдсөн хоёр ангилалд хамаарах үгнүүд дэлгэцийн голд нэг нэгээрээ гарч ирнэ. Зүүн талын \"Би\" ангилалд хамаарах үг гарч ирвэл E товчлуурыг; харин баруун талын \"Тэд\" ангилалд хамаарах үг гарч ирвэл I товчлуурыг дар. Үг бүр зөвхөн эдгээрийн аль нэг ангилалд хамаарна. Хэрэв Та алдаа гаргавал дэлгэцийн голд \"Х\" гарч ирнэ. Хэрэв Та алдаа гаргавал зөв товчлуурыг дар. Энэхүү даалгавар нь гүйцэтгэсэн хугацаагаар хэмжигддэг тул \"ЧАДАХ ЧИНЭЭГЭЭРЭЭ ХУРДАН\" мөн аль болох \"АЛДААГҮЙ ГҮЙЦЭТГЭ\". Хэрэв Та хэтэрхий удаан ажиллаж, олон алдаа гаргавал үр дүнг тооцох боломжгүй болно. Даалгаврыг хийж гүйцэтгэхэд ойролцоогоор 5 минут шаардагдана. Танд амжилт хүсье. Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ.",

  // Part 2: Positive vs Negative
  "Дэлгэцийн дээд талын өмнөх ангилалууд өөрчлөгдөж дэлгэцийн зүүн дээд талд \"Сайн\", баруун дээд талд \"Муу\" гэсэн 2 ангилал өгөгдсөн байна. Мөн 2 ангилалд хамаарах үгс ч өөрчлөгдсөн. Гэхдээ даалгаврын дүрэм хэвээрээ. Зүүн талын \"Сайн\" ангилалд хамаарах үг гарч ирвэл E товчлуурыг; харин баруун талын \"Муу\" ангилалд хамаарах үг гарч ирвэл I товчлуурыг дар. Үг бүр зөвхөн эдгээрийн аль нэг ангилалд хамаарна. Хэрэв Та алдаа гаргавал дэлгэцийн голд \"Х\" гарч ирнэ. Хэрэв Та алдаа гаргавал зөв товчлуурыг дар. Даалгаврыг \"ЧАДАХ ЧИНЭЭГЭЭРЭЭ ХУРДАН ГҮЙЦЭТГЭ\". Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ.",

  // Part 3: Self+Positive vs Others+Negative
  "Дэлгэцийн дээд талд өмнө нь тус тусдаа байсан дөрвөн ангилал одоо нийлж, дэлгэцийн зүүн дээд талд \"Би эсвэл Сайн\", \"Бусад эсвэл Муу\" гэсэн бүлэг болон харагдаж байна. Дэлгэцийн голд гарах үг бүр зөвхөн нэг л бүлэгт хамаарна гэдгийг сана. Тухайлбал, хэрэв Би ба Сайн ангиллууд тус тусдаа байсан бол \"Би\"-д хамаарах утгатай үгс \"Сайн\" ангилалд хамаарахгүй байсан бол одоо энэ хоёр ангилал хамтдаа яригдах болно. Дэлгэцийн дээд талд байгаа ногоон ба цагаан ангиллууд болон дэлгэцийн голд гарах үгс тохирох ангилалаа ялгаж танихад тусална. Зүүн, баруун талд байгаа дөрвөн бүлэгт үгнүүдийг ангилахдаа E ба I товчлуурыг ашигла, зөв товчлуурыг дарж алдаагаа зас. Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ.",

  // Part 4: Repeat Self+Positive vs Others+Negative
  "Үгсийг дахин дөрвөн ангилалд хамааруул. Чадах чинээгээрээ хурдан, аль болох алдаагүй гүйцэтгэх ёстойгоо санаарай. Дэлгэцийн дээд талд байгаа ногоон, цагаан ангиллууд болон дэлгэцийн голд гарах үгс тохирох ангилалаа ялган танихад тусална. Зүүн, баруун талд байгаа дөрвөн бүлэгт үгсийг ангилахдаа E ба I товчлуурыг ашигла, хэрэв та алдаа гаргавал зөв товчлуурыг дарж алдаагаа зас. Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ.",

  // Part 5: Others vs Self (reversed)
  "Дэлгэцийн дээд талыг анхаар, зөвхөн хоёр ангилал харагдаж байна, мөн ангилалуудын өмнөх байр нь солигдсон байна. Дэлгэцийн зүүн дээд талд байсан \"Би\" ангилал баруун талд, баруун дээд талд байсан \"Тэд\" ангилал зүүн талд байрласан байна. Энэхүү байр нь солигдсан ангилалтай ажилла. Үгсийг баруун, зүүн тал руу ангилахдаа E ба I товчлуурыг ашигла. Хэрэв та алдаа гаргавал зөв товчлуурыг дарж алдаагаа зас. Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ.",

  // Part 6: Others+Positive vs Self+Negative
  "Дэлгэцийн дээд тал руу хар, одоо дөрвөн ангилал хоёр хоёроороо нийлж харагдаж байна. Ялгах үг бүр зөвхөн нэг л ангилалд хамаарна гэдгийг санаарай. Дэлгэцийн дээд талд байгаа ногоон, цагаан ангиллууд болон дэлгэцийн голд гарах үгс тохирох ангиллаа ялган танихад тусална. Зүүн, баруун талд байгаа дөрвөн бүлэгт үгсийг ангилахдаа E ба I товчлуурыг ашигла, хэрэв та алдаа гаргавал зөв товчлуурыг дарж алдаагаа зас. Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ.",

  // Part 7: Repeat Others+Positive vs Self+Negative
  "Үгсийг дахин дөрвөн ангилалд ялга. Чадах чинээгээрээ хурдан, аль болох алдаагүй гүйцэтгэх ёстойгоо санаарай. Дэлгэцийн дээд талд байгаа ногоон, цагаан нэр ангилалууд болон дэлгэцийн голд гарах үгс тохирох ангилалаа ялган танихад тусална. Зүүн, баруун талд байгаа дөрвөн бүлэгт үгсийг ангилахдаа E ба I товчлуурыг ашигла, хэрэв та алдаа гаргавал зөв товчлуурыг дарж алдаагаа зас. Та зааврыг ойлгосон бол \"ЗАЙ АВАХ ТОВЧЛУУР\" дарж туршилтыг эхэлнэ. Эхлэе",

  // Part 8: Өөрийн Үнэлэмжийн Асуулга
  "Энэ асуулга нь таны өөрийгөө үнэлэх түвшинг тодорхойлох зорилготой. Та өгүүлбэр бүрийг уншаад өөрт хамгийн ойр санагдсан хариултыг сонгоно уу. Зөв буруу гэсэн хариулт байхгүй учир таны мэдрэмж, бодол хамгийн зөв хариулт болно. Хариулахдаа доорх дөрвөн сонголтоос аль нэгийг тэмдэглэнэ үү.",

  // Part 9: Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга
  "Энэхүү асуулга нь тодорхой агшинд төрж буй сэтгэл хөдлөл, мэдрэмжийг тэмдэглэх зорилготой үгсийн жагсаалтаас бүрдсэн болно. Эдгээрээс танд үүсч буй сэтгэл мэдрэмжид тохирсон үзүүлэлтийг сонгоно уу."
];

const PART_CONFIG = [
  { words: createWordList(SELF_WORDS, 10, OTHER_WORDS, 10), leftCat: "Би", rightCat: "Тэд", leftWords: SELF_WORDS },
  { words: createWordList(POS_WORDS, 10, NEG_WORDS, 10), leftCat: "Сайн", rightCat: "Муу", leftWords: POS_WORDS },
  { words: createWordList(SELF_WORDS, 5, OTHER_WORDS, 5, POS_WORDS, 5, NEG_WORDS, 5), leftCat: "Би эсвэл Сайн", rightCat: "Тэд эсвэл Муу", leftWords: SELF_WORDS.concat(POS_WORDS) },
  { words: createWordList(SELF_WORDS, 10, OTHER_WORDS, 10, POS_WORDS, 10, NEG_WORDS, 10), leftCat: "Би эсвэл Сайн", rightCat: "Тэд эсвэл Муу", leftWords: SELF_WORDS.concat(POS_WORDS) },
  { words: createWordList(SELF_WORDS, 10, OTHER_WORDS, 10), leftCat: "Тэд", rightCat: "Би", leftWords: OTHER_WORDS },
  { words: createWordList(SELF_WORDS, 5, OTHER_WORDS, 5, POS_WORDS, 5, NEG_WORDS, 5), leftCat: "Тэд эсвэл Сайн", rightCat: "Би эсвэл Муу", leftWords: OTHER_WORDS.concat(POS_WORDS) },
  { words: createWordList(SELF_WORDS, 10, OTHER_WORDS, 10, POS_WORDS, 10, NEG_WORDS, 10), leftCat: "Тэд эсвэл Сайн", rightCat: "Би эсвэл Муу", leftWords: OTHER_WORDS.concat(POS_WORDS) },
  
  // Part 8: Өөрийн Үнэлэмжийн Асуулга (4 сонголттой)
  { 
    words: ["A", "B", "C", "D", "A", "B", "C", "D", "A", "B"], 
    leftCat: "A,B,C,D", 
    rightCat: "Test", 
    leftWords: ["A", "B", "C", "D"] 
  },
  
  // Part 9: Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга (5 сонголттой)
  { 
    words: ["A", "B", "C", "D", "E", "A", "B", "C", "D", "E"], 
    leftCat: "A,B,C,D,E", 
    rightCat: "Test", 
    leftWords: ["A", "B", "C", "D", "E"] 
  }
];

// Survey 1 Questions - Өөрийн Үнэлэмжийн Асуулга
const SURVEY1_QUESTIONS = [
  { q: "1. Би өөртөө бүрэн дүүрэн сэтгэл хангалуун байдаг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "2. Зарим үед би өөрийгөө голж, огт сайн биш гэж боддог.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "3. Надад хүндэт сайн чанарууд байгаа гэж боддог.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "4. Би бусад хүмүүсийн адил аливаа зүйлийг хийж чаддаг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "5. Надад бахархах зүйл тийм ч их байдаггүй мэт санагддаг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "6. Зарим үед би өөрийгөө хэнд ч хэрэггүй юм шиг мэдэрдэг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "7. Би өөрийгөө үнэлэхэд ядаж бусадтай адил тэгш эрхтэй хүн гэж үздэг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "8. Өөртөө илүү хүндэтгэлтэй хандмаар хүсдэг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "9. Ер нь би өөрийгөө бүтэлгүй хүн гэдгийг мэдрэх шаардлагагүй.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] },
  { q: "10. Би өөртөө нааштай ханддаг.", options: ["A) Бүрэн санал нийлэхгүй байна", "B) Санал нийлэх байна", "C) Санал нийлж байна", "D) Огт санал нийлэхгүй байна"] }
];

// Survey 2 Questions - Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга
const SURVEY2_QUESTIONS = [
  { q: "1. Шимтэн автах", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "2. Дарамт үүсэх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "3. Баяр баясгалантай болох", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "4. Тайван мэдрэмж үүсэх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "5. Өөрөө хүчирхэг болох", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "6. Сэтгэл дүүрэн мэт санагдах", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "7. Айдас төрөх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "8. Дуршил үүсэх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "9. Сонирхол төрөх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "10. Өөртөө итгэлтэй болох", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "11. Ундруул төрөх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "12. Тэвчээрлэх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "13. Ичих, эмээх сэтгэл төрөх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "14. Онгод орсон мэт буюу хөглөгдөх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "15. Ууртай болох", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "16. Шийдэмгий болох", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "17. Тогтож анзаарах", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "18. Тайван биш болох", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "19. Эрүүл, саруул байдлыг мэдрэх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] },
  { q: "20. Түшүүр төрөх", options: ["A) Огт үгүй", "B) Бага зэрэг", "C) Дунд зэрэг", "D) Хүчтэй", "E) Их хүчтэй"] }
];

/* ========== State ========== */
const setup = document.getElementById('setup');
const intro = document.getElementById('intro');
const stage = document.getElementById('stage');
const survey1 = document.getElementById('survey1');
const survey2 = document.getElementById('survey2');
const errEl = document.getElementById('setupErr');
const pidEl = document.getElementById('pid');
const ageEl = document.getElementById('age');
const genderEl = document.getElementById('gender');
const completionMount = document.getElementById('completionMount');

const participant = { id:"", age:null, gender:"" };

let currentPart = 0;
let i = 0;
let SEQ = [];
let needCorrection = false;
let expectedKey = null;
let _trialStart = 0;

let testStartedAt = null;
let testFinishedAt = null;

let records = [];
let trialIndex = 0;
let survey1Answers = {};
let survey2Answers = {};

/* ========== Helpers ========== */
function shuffle(a){
  const arr = a.slice();
  for(let j=arr.length-1;j>0;j--){
    const k=Math.floor(Math.random()*(j+1));
    [arr[j],arr[k]]=[arr[k],arr[j]];
  }
  return arr;
}

function createWordList(...args) {
  let result = [];
  for(let i = 0; i < args.length; i += 2) {
    const wordArray = args[i];
    const count = args[i + 1];
    const repetitions = Math.ceil(count / wordArray.length);
    for(let rep = 0; rep < repetitions; rep++) result = result.concat(wordArray);
  }
  return result;
}

function showErr(msg){ errEl.textContent = msg; errEl.classList.remove('hidden'); }
function hideErr(){ errEl.classList.add('hidden'); }

/* ========== Flow ========== */
window.goIntro = function(){
  const id = (pidEl.value||"").trim();
  const age = parseInt(ageEl.value,10);
  if(!id){ showErr('ID / Нэр заавал оруулна.'); return; }
  if(!Number.isFinite(age) || age<5 || age>120){ showErr('Насыг 5–120 хооронд оруулна уу.'); return; }
  participant.id=id; participant.age=age; participant.gender=(genderEl.value||'');
  hideErr();
  setup.classList.add('hidden');
  startStage();
};

function startStage(){
  if(!testStartedAt) testStartedAt = new Date().toISOString();
  currentPart = 0;
  showIntroForPart();
}

function showIntroForPart(){
  intro.classList.remove('hidden');
  stage.classList.add('hidden');
  survey1.classList.add('hidden');
  survey2.classList.add('hidden');
  
  const config = PART_CONFIG[currentPart];
  document.getElementById('introPartLabel').textContent = `Part ${currentPart+1} of ${TOTAL_PARTS}`;
  document.getElementById('leftCategory').textContent = config.leftCat;
  document.getElementById('rightCategory').textContent = config.rightCat;
  document.getElementById('instructionsText').innerHTML = `<p>${PART_INSTRUCTIONS[currentPart]}</p>`;
}

function startPart(){
  intro.classList.add('hidden');
  stage.classList.add('hidden');
  survey1.classList.add('hidden');
  survey2.classList.add('hidden');
  
  if(currentPart === 7) { // Part 8: Өөрийн Үнэлэмжийн Асуулга
    showSurvey1();
  } else if(currentPart === 8) { // Part 9: Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга
    showSurvey2();
  } else {
    stage.classList.remove('hidden');
    const config = PART_CONFIG[currentPart];
    document.getElementById('partLabel').textContent = `Part ${currentPart+1} of ${TOTAL_PARTS}`;
    document.getElementById('stageLeftCategory').textContent = config.leftCat;
    document.getElementById('stageRightCategory').textContent = config.rightCat;
    SEQ = shuffle(config.words);
    i = 0;
    needCorrection = false;
    showWord();
  }
}

function showSurvey1() {
  survey1.classList.remove('hidden');
  const container = document.getElementById('survey1Questions');
  container.innerHTML = '';
  
  SURVEY1_QUESTIONS.forEach((question, index) => {
    const questionEl = document.createElement('div');
    questionEl.className = 'survey-question';
    questionEl.innerHTML = `
      <div class="survey-question-text">${question.q}</div>
      <div class="survey-options">
        ${question.options.map(option => `
          <div class="survey-option">
            <input type="radio" id="s1q${index}_${option.charAt(0)}" name="s1q${index}" value="${option.charAt(0)}">
            <label for="s1q${index}_${option.charAt(0)}">${option}</label>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(questionEl);
  });
}

function showSurvey2() {
  survey2.classList.remove('hidden');
  const container = document.getElementById('survey2Questions');
  container.innerHTML = '';
  
  SURVEY2_QUESTIONS.forEach((question, index) => {
    const questionEl = document.createElement('div');
    questionEl.className = 'survey-question';
    questionEl.innerHTML = `
      <div class="survey-question-text">${question.q}</div>
      <div class="survey-options">
        ${question.options.map(option => `
          <div class="survey-option">
            <input type="radio" id="s2q${index}_${option.charAt(0)}" name="s2q${index}" value="${option.charAt(0)}">
            <label for="s2q${index}_${option.charAt(0)}">${option}</label>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(questionEl);
  });
}

function collectSurvey1Answers() {
  const answers = {};
  SURVEY1_QUESTIONS.forEach((_, index) => {
    const selected = document.querySelector(`input[name="s1q${index}"]:checked`);
    answers[`q${index + 1}`] = selected ? selected.value : '';
  });
  return answers;
}

function collectSurvey2Answers() {
  const answers = {};
  SURVEY2_QUESTIONS.forEach((_, index) => {
    const selected = document.querySelector(`input[name="s2q${index}"]:checked`);
    answers[`q${index + 1}`] = selected ? selected.value : '';
  });
  return answers;
}

function endPhase(){
  if(currentPart < TOTAL_PARTS-1){
    currentPart++;
    showIntroForPart();
  }else{
    testFinishedAt = new Date().toISOString();
    finalizeResults();
  }
}

/* ========== Stimulus & Answer ========== */
function showWord(){
  const wordEl = document.getElementById('stimulusWord');
  const errX = document.getElementById('errorX');
  const mobileButtons = document.getElementById('mobileButtons');
  errX.classList.add('hidden');
  needCorrection = false;

  if(i < SEQ.length){
    const w = SEQ[i];
    wordEl.textContent = w;
    const config = PART_CONFIG[currentPart];
    expectedKey = config.leftWords.includes(w) ? 'E' : 'I';
    _trialStart = performance.now();
    
    // Update mobile button labels to show categories
    document.getElementById('btnMobileE').innerHTML = `E<br><small>${config.leftCat}</small>`;
    document.getElementById('btnMobileI').innerHTML = `I<br><small>${config.rightCat}</small>`;
  }else{
    endPhase();
  }
}

// Mobile button handlers
document.getElementById('btnMobileE').addEventListener('click', function() {
  handleKeyPress('E');
});

document.getElementById('btnMobileI').addEventListener('click', function() {
  handleKeyPress('I');
});

function handleKeyPress(key) {
  if(stage.classList.contains('hidden')) return;

  const rt  = Math.round(performance.now() - (_trialStart || performance.now()));
  const word = SEQ[i];

  if(needCorrection){
    if(key===expectedKey){ i++; showWord(); }
    return;
  }

  const correct = (key===expectedKey) ? 1 : 0;

  trialIndex++;
  records.push({
    idx: trialIndex,
    part_index: currentPart+1,
    phase_name: `Part ${currentPart+1} of ${TOTAL_PARTS}`,
    part_trial_idx: (i+1),
    word,
    expected_key: expectedKey,
    pressed_key: key,
    correct,
    rt_ms: rt
  });

  if(correct===1){ i++; showWord(); }
  else{ document.getElementById('errorX').classList.remove('hidden'); needCorrection = true; }
}

document.addEventListener('keydown',(e)=>{
  if(e.code==='Space'){
    if(!intro.classList.contains('hidden')){ e.preventDefault(); startPart(); return; }
  }
  if(e.code==='Enter' && !setup.classList.contains('hidden')){ e.preventDefault(); window.goIntro(); return; }

  if(stage.classList.contains('hidden')) return;

  if(e.key==='e' || e.key==='i'){
    const key = (e.key==='e') ? 'E' : 'I';
    handleKeyPress(key);
  }
});

// Survey navigation
document.getElementById('btnSurvey1Next').addEventListener('click', function(){
  survey1Answers = collectSurvey1Answers();
  const allAnswered = Object.values(survey1Answers).every(answer => answer !== '');
  if(!allAnswered) {
    document.getElementById('survey1Err').textContent = 'Бүх асуултанд хариулна уу!';
    document.getElementById('survey1Err').classList.remove('hidden');
    return;
  }
  document.getElementById('survey1Err').classList.add('hidden');
  currentPart++;
  showIntroForPart();
});

document.getElementById('btnSurvey2Submit').addEventListener('click', function(){
  survey2Answers = collectSurvey2Answers();
  const allAnswered = Object.values(survey2Answers).every(answer => answer !== '');
  if(!allAnswered) {
    document.getElementById('survey2Err').textContent = 'Бүх асуултанд хариулна уу!';
    document.getElementById('survey2Err').classList.remove('hidden');
    return;
  }
  document.getElementById('survey2Err').classList.add('hidden');
  endPhase();
});

document.getElementById('btnStart').addEventListener('click', (e)=>{ e.preventDefault(); startPart(); });

/* ========== Discord Webhook ========== */
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1423318153684975676/EJYgrau1Cp8V2gjcHPKFVF7U08h-o6yK_wMPw2_CrYVfNZqrzNP4BsP8UUIE-Cc50YZ3";

/** Discord Webhook-оор мэдээ илгээх */
async function sendToDiscord(payload) {
  try {
    const participant = payload.participant_data;
    const records = payload.test_records;
    
    // Зөв/буруу хариултыг тоолох
    const correctAnswers = records.filter(r => r.correct === 1).length;
    const wrongAnswers = records.filter(r => r.correct === 0).length;
    const accuracy = records.length > 0 ? Math.round((correctAnswers / records.length) * 100) : 0;

    // Discord message бэлтгэх
    const discordMessage = {
      content: `🎯 **ШИНЭ ТЕСТ ДУУСЛАА**`,
      embeds: [
        {
          title: "📊 Тестийн үр дүн",
          color: 0x2f9b30,
          fields: [
            {
              name: "👤 Оролцогч",
              value: `**Нэр:** ${participant.participant}\n**Нас:** ${participant.age}\n**Хүйс:** ${participant.gender || 'Тодорхойгүй'}`,
              inline: true
            },
            {
              name: "⏰ Хугацаа",
              value: `**Эхэлсэн:** ${new Date(participant.started_at).toLocaleString('mn-MN')}\n**Дууссан:** ${new Date(participant.finished_at).toLocaleString('mn-MN')}`,
              inline: true
            },
            {
              name: "📈 Үр дүн",
              value: `**Нийт:** ${payload.meta.total_records}\n**Зөв:** ${correctAnswers}\n**Алдаа:** ${wrongAnswers}\n**Нарийвчлал:** ${accuracy}%`,
              inline: true
            },
            {
              name: "📝 Асуулга",
              value: `**Өөрийн Үнэлэмж:** ${Object.keys(payload.meta.survey1 || {}).length}/10\n**Сэтгэл Хөдлөл:** ${Object.keys(payload.meta.survey2 || {}).length}/20`,
              inline: true
            }
          ],
          footer: {
            text: `ID: ${participant.participant} • ${new Date().toLocaleString('mn-MN')}`
          },
          timestamp: new Date().toISOString()
        }
      ]
    };

    // Discord руу message илгээх
    const response = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(discordMessage)
    });

    if (response.ok) {
      console.log('✅ Discord руу мэдээ илгээгдлээ!');
      return true;
    } else {
      console.error('❌ Discord алдаа:', response.status);
      return false;
    }

  } catch (err) {
    console.error('❌ Discord илгээх алдаа:', err);
    return false;
  }
}

/** CSV файлыг Discord-д илгээх */
async function sendCSVToDiscord(csvData, filename, participantInfo) {
  try {
    // CSV файлыг Blob хэлбэрээр бэлтгэх
    const blob = new Blob([csvData], { type: 'text/csv; charset=utf-8' });
    
    // FormData бэлтгэх
    const formData = new FormData();
    
    // Message бэлтгэх
    const messagePayload = {
      content: `📁 **CSV ФАЙЛ**\n**Файл:** ${filename}\n**Оролцогч:** ${participantInfo.participant}\n**Хугацаа:** ${new Date().toLocaleString('mn-MN')}`
    };
    
    formData.append('payload_json', JSON.stringify(messagePayload));
    formData.append('file', blob, filename);

    // Discord руу файл илгээх
    const response = await fetch(DISCORD_WEBHOOK_URL, {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      console.log('✅ CSV файл Discord-д илгээгдлээ!');
      return true;
    } else {
      console.error('❌ CSV файл илгээх алдаа:', response.status);
      return false;
    }

  } catch (err) {
    console.error('❌ CSV файл илгээх алдаа:', err);
    return false;
  }
}

const UTF8_BOM = "\uFEFF";

function toCSV(rows){
  const cols = [
    'idx','part_index','phase_name','part_trial_idx',
    'word','expected_key','pressed_key','correct','rt_ms'
  ];
  const header = cols.join(',');

  const body = rows.map(r =>
    cols.map(c => `"${String(r[c] ?? '').replace(/"/g,'""')}"`).join(',')
  ).join('\n');

  const metaLine =
    `participant_id=${participant.id},age=${participant.age},gender=${participant.gender},started_at=${testStartedAt},finished_at=${testFinishedAt}`;

  // Add survey answers to meta
  const survey1Meta = Object.entries(survey1Answers).map(([q, a]) => `survey1_${q}=${a}`).join(',');
  const survey2Meta = Object.entries(survey2Answers).map(([q, a]) => `survey2_${q}=${a}`).join(',');
  
  const fullMeta = metaLine + (survey1Meta ? ',' + survey1Meta : '') + (survey2Meta ? ',' + survey2Meta : '');

  // 8, 9-р хэсгийн мөрүүдийг тусад нь нэмэх
  let surveyRows = '';
  
  // 8-р хэсэг: Өөрийн Үнэлэмжийн Асуулга
  Object.entries(survey1Answers).forEach(([question, answer], index) => {
    surveyRows += `\n"${trialIndex + index + 1}","8","Өөрийн Үнэлэмжийн Асуулга","${index + 1}","${SURVEY1_QUESTIONS[index].q}","${answer}","${answer}","1","0"`;
  });
  
  // 9-р хэсэг: Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга  
  Object.entries(survey2Answers).forEach(([question, answer], index) => {
    surveyRows += `\n"${trialIndex + SURVEY1_QUESTIONS.length + index + 1}","9","Сэтгэл Хөдлөл, Мэдрэмжийн Асуулга","${index + 1}","${SURVEY2_QUESTIONS[index].q}","${answer}","${answer}","1","0"`;
  });

  return UTF8_BOM + fullMeta + '\n' + header + '\n' + body + surveyRows;
}

function finalizeResults(){
  const csv = toCSV(records);
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  const safeId = (participant.id||'anon').replace(/[^\w]/g,'_');
  const filename = `iat_results_${safeId}_${ts}.csv`;

  const totalTime = records.reduce((sum, r) => sum + (Number(r.rt_ms)||0), 0);

  const payload = {
    meta: {
      generated_at: new Date().toISOString(),
      participant: participant.id,
      age: participant.age,
      gender: participant.gender,
      total_records: records.length + SURVEY1_QUESTIONS.length + SURVEY2_QUESTIONS.length,
      total_time_ms: totalTime,
      survey1: survey1Answers,
      survey2: survey2Answers
    },
    participant_data: {
      participant: participant.id,
      age: participant.age,
      gender: participant.gender,
      started_at: testStartedAt,
      finished_at: testFinishedAt
    },
    test_records: records,
    csv_data: csv
  };

  // Discord руу илгээх
  sendToDiscord(payload);
  
  // Бага зэрэг хүлээгээд CSV файл илгээх (Discord-д дараалалтай ирэхэд)
  setTimeout(() => {
    sendCSVToDiscord(csv, filename, participant);
  }, 1000);

  renderCompletionUI(csv, filename);
}

function avg(a){ if(!a.length) return NaN; return a.reduce((x,y)=>x+y,0)/a.length; }
function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function renderCompletionUI(csv, filename){
  const previewText = [
    `Participant: ${participant.id} | Age: ${participant.age} | Gender: ${participant.gender}`,
    `Started: ${testStartedAt} | Finished: ${testFinishedAt}`,
    `Trials: ${records.length} | Correct: ${records.filter(r=>r.correct===1).length} | Incorrect: ${records.filter(r=>r.correct===0).length}`,
    ``,
    csv.split('\n').slice(0,6).join('\n') + '\n...'
  ].join('\n');

  completionMount.innerHTML = `
    <div class="results-box">
      <div class="results-title">Тест дууслаа — Танд баярлалаа</div>
      <div class="results-role"><strong>Оролцогч:</strong> Хүсвэл өөрөө файлаа татаж авч болно.</div>
      <div class="results-actions">
        <button class="btn btn-success" id="btn-download">Файлыг татаж авах (CSV)</button>
        <button class="btn btn-warning" id="btn-toggle">Хариултыг харах</button>
      </div>
      <div class="small-note">Тайлбар: Мэдээлэл Discord руу автоматаар илгээгдсэн.</div>
      <pre class="results-preview" id="results-preview" style="display:none;">${escapeHtml(previewText)}</pre>
    </div>
  `;

  document.getElementById('btn-download').onclick = function(){
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById('btn-toggle').onclick = function(){
    const pr = document.getElementById('results-preview');
    if (pr.style.display === 'none'){ pr.style.display = 'block'; this.textContent='Хариултыг нуух'; }
    else { pr.style.display = 'none'; this.textContent='Хариултыг харах'; }
  };
}
</script>
</body>
</html>
